name: ğŸš€ Auto Deploy Bot to Server

# Ğ¢Ñ€Ğ¸Ğ³ĞµÑ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    types: [ closed ]

# Ğ—Ğ¼Ñ–Ğ½Ğ½Ñ– Ğ´Ğ»Ñ Ğ²ÑÑŒĞ¾Ğ³Ğ¾ workflow
env:
  NODE_VERSION: '18'
  APP_NAME: 'tg-onboarding-bot'
  DEPLOY_PATH: '/home/roman/apps/tg-onboarding'

jobs:
  # Job 1: Ğ¢ĞµÑÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ‚Ğ° Ğ²Ğ°Ğ»Ñ–Ğ´Ğ°Ñ†Ñ–Ñ
  test:
    name: ğŸ§ª Test & Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'tg_bot/package-lock.json'
          
      - name: ğŸ“¦ Install Dependencies
        working-directory: ./tg_bot
        run: npm ci
        
      - name: ğŸ” Validate Configuration
        working-directory: ./tg_bot
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          NODE_ENV: production
        run: |
          echo "ğŸ”§ Validating bot configuration..."
          npm run validate
          
      - name: âœ… Check Token Security
        working-directory: ./tg_bot
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          echo "ğŸ”‘ Checking token format..."
          npm run check-token

  # Job 2: Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€ (Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ¿Ñ–ÑĞ»Ñ ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµÑÑ‚Ñƒ)
  deploy:
    name: ğŸš€ Deploy to Server
    runs-on: ubuntu-latest
    needs: test
    # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ¿Ñ€Ğ¸ push Ğ² main Ñ‚Ğ° Ğ·Ğ°ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ– PR
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: ğŸŒ Add Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          # Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ±Ñ–Ğ»ÑŒÑˆ Ğ½Ğ°Ğ´Ñ–Ğ¹Ğ½Ğ¸Ğ¹ Ğ¿Ñ–Ğ´Ñ…Ñ–Ğ´ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ´Ğ°Ğ²Ğ°Ğ½Ğ½Ñ Ñ…Ğ¾ÑÑ‚Ğ°
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts || echo "Warning: ssh-keyscan failed, using StrictHostKeyChecking=no"
          # ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¸Ğ¹ ÑĞ¿Ğ¾ÑÑ–Ğ± - Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¸ ĞºĞ¾Ğ½Ñ„Ñ–Ğ³ÑƒÑ€Ğ°Ñ†Ñ–Ñ SSH
          cat >> ~/.ssh/config << EOF
          Host ${{ secrets.HOST }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          
      - name: ğŸ”— Test SSH Connection
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
        run: |
          echo "ğŸ”— Testing SSH connection to $USERNAME@$HOST..."
          ssh -o ConnectTimeout=10 -o BatchMode=yes $USERNAME@$HOST "echo 'SSH connection successful'" || {
            echo "âŒ SSH connection failed!"
            echo "ğŸ’¡ Possible solutions:"
            echo "   1. Check HOST secret is correct IP: $HOST"
            echo "   2. Check USERNAME secret: $USERNAME"
            echo "   3. Check SSH_PRIVATE_KEY is complete"
            echo "   4. Ensure server is accessible from GitHub Actions"
            exit 1
          }
          
      - name: ğŸ”„ Deploy to Server
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
        run: |
          echo "ğŸš€ Starting deployment to $HOST..."
          
          # Ğ’Ğ¸ĞºĞ¾Ğ½Ğ°Ğ½Ğ½Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ñ– Ñ‡ĞµÑ€ĞµĞ· SSH
          ssh $USERNAME@$HOST << 'DEPLOY_SCRIPT'
            set -e  # Ğ—ÑƒĞ¿Ğ¸Ğ½Ğ¸Ñ‚Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ñ†Ñ–
            
            echo "ğŸ“ Navigating to deployment directory..."
            cd ${{ env.DEPLOY_PATH }} || {
              echo "âŒ Deployment directory not found. Creating..."
              mkdir -p ${{ env.DEPLOY_PATH }}
              cd ${{ env.DEPLOY_PATH }}
            }
            
            echo "ğŸ“¥ Pulling latest code..."
            if [ -d ".git" ]; then
              git fetch origin
              git reset --hard origin/main
            else
              git clone https://github.com/${{ github.repository }}.git .
            fi
            
            echo "ğŸ“¦ Installing dependencies..."
            cd tg_bot
            npm ci --only=production
            
            echo "ğŸ”§ Setting up environment..."
            echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > .env
            echo "NODE_ENV=production" >> .env
            echo "LOG_LEVEL=info" >> .env
            
            echo "âœ… Validating configuration..."
            npm run validate
            
            echo "ğŸ”„ Restarting bot service..."
            # Ğ—ÑƒĞ¿Ğ¸Ğ½Ğ¸Ñ‚Ğ¸ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑ (ÑĞºÑ‰Ğ¾ Ñ”)
            pkill -f "node.*index.mjs" || echo "No existing process found"
            
            # Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğ¸ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑ Ğ² Ñ„Ğ¾Ğ½Ñ–
            nohup npm start > ../bot.log 2>&1 &
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“Š Bot status:"
            sleep 2
            ps aux | grep "node.*index.mjs" | grep -v grep || echo "âŒ Bot not running"
          DEPLOY_SCRIPT
          
      - name: ğŸ¥ Health Check
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
        run: |
          echo "ğŸ¥ Performing health check..."
          sleep 5
          
          ssh $USERNAME@$HOST << 'HEALTH_CHECK'
            cd ${{ env.DEPLOY_PATH }}
            
            # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ñ‰Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¸Ğ¹
            if pgrep -f "node.*index.mjs" > /dev/null; then
              echo "âœ… Bot is running"
              echo "ğŸ“Š Process info:"
              ps aux | grep "node.*index.mjs" | grep -v grep
            else
              echo "âŒ Bot is not running"
              echo "ğŸ“‹ Last 10 lines of log:"
              tail -10 bot.log || echo "No log file found"
              exit 1
            fi
          HEALTH_CHECK
          
      - name: ğŸ“¢ Notify Success
        if: success()
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "âœ… Bot deployed to: ${{ secrets.HOST }}"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          
      - name: ğŸš¨ Notify Failure
        if: failure()
        run: |
          echo "ğŸ’¥ Deployment failed!"
          echo "âŒ Check logs above for details"
          echo "ğŸ”§ Manual intervention may be required"

  # Job 3: ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ (Ğ·Ğ°Ğ²Ğ¶Ğ´Ğ¸ Ğ²Ğ¸ĞºĞ¾Ğ½ÑƒÑ”Ñ‚ÑŒÑÑ)
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()
    
    steps:
      - name: ğŸ§¹ Cleanup Workspace
        run: |
          echo "ğŸ§¹ Cleaning up workspace..."
          echo "ğŸ“Š Workflow completed for commit: ${{ github.sha }}"
