name: Deploy Bot to Server

on:
  push:
    branches: [ main ]
    paths:
      - 'tg_bot/**'
      - '!tg_bot/pdf/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ –ü–æ—á–∞—Ç–æ–∫ –¥–µ–ø–ª–æ—é –±–æ—Ç–∞..."
            
            # –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –ø—Ä–æ–µ–∫—Ç—É
            cd /home/roman/–°—Ç—ñ–ª—å–Ω–∏—Ü—è/projeckt/tg-onboarding
            
            # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É –∑ GitHub
            echo "üì• –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É..."
            git pull origin main
            
            # –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –±–æ—Ç–∞
            cd tg_bot
            
            # –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
            echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
            npm ci --only=production
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É (–±–µ–∑ sudo)
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
            systemctl --user restart skillklan-bot || echo "–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É, —Å–ø—Ä–æ–±—É—î–º–æ —á–µ—Ä–µ–∑ sudo"
            
            # –Ø–∫—â–æ –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ, —Å–ø—Ä–æ–±—É—î–º–æ —á–µ—Ä–µ–∑ sudo
            if ! systemctl --user is-active --quiet skillklan-bot; then
              echo "üîÑ –°–ø—Ä–æ–±—É—î–º–æ —á–µ—Ä–µ–∑ sudo..."
              sudo systemctl restart skillklan-bot
            fi
            
            # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É
            echo "‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É..."
            systemctl --user status skillklan-bot --no-pager || sudo systemctl status skillklan-bot --no-pager
            
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
