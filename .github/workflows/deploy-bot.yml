name: Deploy Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-bot
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server via SSH (pin to exact commit)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 2222
          timeout: 2m
          command_timeout: 15m
          script_stop: true
          envs: GITHUB_SHA
          script: |
            set -euo pipefail

            # –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–Ø: —É–Ω–∏–∫–∞–π –∫–∏—Ä–∏–ª–∏—Ü—ñ —Ç–∞ –ø—Ä–æ–±—ñ–ª—ñ–≤ —É —à–ª—è—Ö—É –¥–ª—è systemd
            REPO_DIR="/home/roman/apps/tg-onboarding"
            SERVICE="skillklan-bot"
            SUBDIR="tg_bot"   # —è–∫—â–æ package.json –ª–µ–∂–∏—Ç—å —É –ø—ñ–¥–ø–∞–ø—Ü—ñ
            TARGET_SHA="${GITHUB_SHA}"

            echo "üöÄ –î–µ–ø–ª–æ–π –±–æ—Ç–∞ –Ω–∞ SHA $TARGET_SHA"

            # 1) –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ –ø–∞–ø–∫–∞ —ñ—Å–Ω—É—î —ñ git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –∫–æ—Ä–µ–∫—Ç–Ω–∏–π
            if [ ! -d "$REPO_DIR/.git" ]; then
              echo "‚ÑπÔ∏è –†–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –≤—ñ–¥—Å—É—Ç–Ω—ñ–π ‚Äî –∫–ª–æ–Ω—É—é –∑–∞–Ω–æ–≤–æ‚Ä¶"
              mkdir -p "$REPO_DIR"
              git clone --no-tags --filter=blob:none --branch main https://github.com/skillklan/tg-onboarding.git "$REPO_DIR"
            fi

            cd "$REPO_DIR"

            # –î–æ–∑–≤–æ–ª–∏—Ç–∏ git –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —É –∫–∞—Ç–∞–ª–æ–∑—ñ –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–ª–∞—Å–Ω–∏–∫ –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è
            git config --global --add safe.directory "$REPO_DIR"

            # 2) –û–Ω–æ–≤–∏ —Ä–µ–º–æ—É—Ç —ñ –≤–∏—Ç—è–≥–Ω–∏ –∫–æ–º—ñ—Ç–∏, –∞–ª–µ –Ω–µ –ø–µ—Ä–µ–º–∏–∫–∞–π—Å—è –Ω–∞ "–æ—Å—Ç–∞–Ω–Ω—ñ–π"
            git fetch --all --prune --depth=100

            # 3) –ñ–æ—Ä—Å—Ç–∫–æ –≤–∏—Å—Ç–∞–≤ —Å–∞–º–µ —Ç–æ–π –∫–æ–º—ñ—Ç, —â–æ –∑–∞–ø—É—Å—Ç–∏–≤ workflow
            echo "üîí Reset to exact SHA"
            git checkout --quiet main
            git reset --hard "$TARGET_SHA"

            # 4) –í–∏–≤–µ–¥–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è, —â–æ –º–∏ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –∫–æ–º—ñ—Ç—ñ
            CURRENT_SHA="$(git rev-parse HEAD)"
            echo "Deployed commit: $CURRENT_SHA"
            test "$CURRENT_SHA" = "$TARGET_SHA"

            # 5) –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–¥-–∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
            cd "$REPO_DIR/$SUBDIR"
            export NODE_ENV=production
            if [ -f package-lock.json ]; then
              npm ci --omit=dev
            else
              npm install --omit=dev
            fi

            # 6) –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤—ñ—Å—É
            echo "üß∞ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤—ñ—Å—É‚Ä¶"
            sudo systemctl daemon-reload || true
            sudo systemctl restart "$SERVICE"

            # 7) –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ —Å–µ—Ä–≤—ñ—Å –∞–∫—Ç–∏–≤–Ω–∏–π
            if sudo systemctl is-active --quiet "$SERVICE"; then
              echo "‚úÖ –°–µ—Ä–≤—ñ—Å –∑–∞–ø—É—â–µ–Ω–æ"
            else
              echo "‚ùå –°–µ—Ä–≤—ñ—Å –Ω–µ —Å—Ç–∞—Ä—Ç—É–≤–∞–≤"
              sudo systemctl status "$SERVICE" --no-pager || true
              exit 1
            fi

            # 8) –®–≤–∏–¥–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–±–æ—á–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥—É systemd (—á–∞—Å—Ç–∞ –ø–æ–º–∏–ª–∫–∞ CHDIR)
            echo "‚ÑπÔ∏è –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–±–æ—á–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥—É —Å–µ—Ä–≤—ñ—Å—É:"
            sudo systemctl show "$SERVICE" -p ExecStart -p WorkingDirectory

            # 9) –û—Å—Ç–∞–Ω–Ω—ñ –ª–æ–≥–∏ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            echo "‚ÑπÔ∏è –û—Å—Ç–∞–Ω–Ω—ñ –ª–æ–≥–∏:"
            sudo journalctl -u "$SERVICE" -n 80 --no-pager