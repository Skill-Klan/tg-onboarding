name: Update Bot Code

on:
  push:
    branches: [ main ]
    paths:
      - 'tg_bot/**'
      - '!tg_bot/pdf/**'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Update code on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É –±–æ—Ç–∞..."
            
            # –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –ø—Ä–æ–µ–∫—Ç—É
            cd /home/roman/–°—Ç—ñ–ª—å–Ω–∏—Ü—è/projeckt/tg-onboarding
            
            # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É –∑ GitHub
            echo "üì• –û—Ç—Ä–∏–º–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω—å..."
            git pull origin main
            
            # –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –±–æ—Ç–∞
            cd tg_bot
            
            # –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
            echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
            npm ci --only=production
            
            echo "‚úÖ –ö–æ–¥ –æ–Ω–æ–≤–ª–µ–Ω–æ! –¢–µ–ø–µ—Ä –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞ –≤—Ä—É—á–Ω—É."
            echo "üí° –í–∏–∫–æ–Ω–∞–π—Ç–µ: sudo systemctl restart skillklan-bot"
