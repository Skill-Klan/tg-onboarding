#!/bin/bash

echo "üî• –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ñ–∞–π—Ä–≤–æ–ª–∞..."

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ ufw –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π
if command -v ufw >/dev/null 2>&1; then
    echo "‚úÖ UFW –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å
    UFW_STATUS=$(sudo ufw status | grep "Status")
    echo "üìä –°—Ç–∞—Ç—É—Å UFW: $UFW_STATUS"
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –ø–æ—Ä—Ç 3000 –≤—ñ–¥–∫—Ä–∏—Ç–∏–π
    if sudo ufw status | grep -q "3000"; then
        echo "‚úÖ –ü–æ—Ä—Ç 3000 –≤–∂–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π —É UFW"
    else
        echo "üîí –ü–æ—Ä—Ç 3000 –∑–∞–∫—Ä–∏—Ç–∏–π —É UFW"
        echo "üí° –î–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –≤–∏–∫–æ–Ω–∞–π—Ç–µ: sudo ufw allow 3000"
        
        read -p "üîì –í—ñ–¥–∫—Ä–∏—Ç–∏ –ø–æ—Ä—Ç 3000 –∑–∞—Ä–∞–∑? (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            sudo ufw allow 3000
            echo "‚úÖ –ü–æ—Ä—Ç 3000 –≤—ñ–¥–∫—Ä–∏—Ç–æ"
        fi
    fi
else
    echo "‚ùå UFW –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    echo "üí° –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å: sudo apt install ufw"
fi

echo ""

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ iptables –¥–æ—Å—Ç—É–ø–Ω–∏–π
if command -v iptables >/dev/null 2>&1; then
    echo "‚úÖ iptables –¥–æ—Å—Ç—É–ø–Ω–∏–π"
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø–æ—Ä—Ç—É 3000
    if sudo iptables -L INPUT -n | grep -q ":3000"; then
        echo "‚úÖ –ü–æ—Ä—Ç 3000 –≤—ñ–¥–∫—Ä–∏—Ç–∏–π —É iptables"
    else
        echo "üîí –ü–æ—Ä—Ç 3000 –∑–∞–∫—Ä–∏—Ç–∏–π —É iptables"
        echo "üí° –î–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –≤–∏–∫–æ–Ω–∞–π—Ç–µ: sudo iptables -A INPUT -p tcp --dport 3000 -j ACCEPT"
    fi
else
    echo "‚ùå iptables –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π"
fi

echo ""

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ netfilter-persistent –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π
if command -v netfilter-persistent >/dev/null 2>&1; then
    echo "‚úÖ netfilter-persistent –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    echo "üí° –ü—Ä–∞–≤–∏–ª–∞ iptables –±—É–¥—É—Ç—å –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è"
else
    echo "‚ö†Ô∏è  netfilter-persistent –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    echo "üí° –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å: sudo apt install netfilter-persistent"
fi

echo ""

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –ø–æ—Ä—Ç –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É—î—Ç—å—Å—è
echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É–≤–∞–Ω–Ω—è –ø–æ—Ä—Ç—É 3000..."
if netstat -tuln 2>/dev/null | grep -q ":3000 "; then
    echo "‚úÖ –ü–æ—Ä—Ç 3000 –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É—î—Ç—å—Å—è"
    LISTENING_PROCESS=$(netstat -tuln 2>/dev/null | grep ":3000 " | awk '{print $7}' | cut -d'/' -f1)
    if [ ! -z "$LISTENING_PROCESS" ]; then
        PROCESS_NAME=$(ps -p $LISTENING_PROCESS -o comm= 2>/dev/null)
        echo "üì± –ü—Ä–æ—Ü–µ—Å: $PROCESS_NAME (PID: $LISTENING_PROCESS)"
    fi
else
    echo "‚ùå –ü–æ—Ä—Ç 3000 –Ω–µ –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É—î—Ç—å—Å—è"
    echo "üí° –ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä: npm start"
fi

echo ""

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–æ–≤–Ω—ñ—à–Ω—é –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å
echo "üåê –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–æ–≤–Ω—ñ—à–Ω—å–æ—ó –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ..."
PUBLIC_IP=$(curl -s --max-time 5 ifconfig.me 2>/dev/null)

if [ ! -z "$PUBLIC_IP" ]; then
    echo "‚úÖ –ü—É–±–ª—ñ—á–Ω–∞ IP: $PUBLIC_IP"
    
    # –¢–µ—Å—Ç—É—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –∑–æ–≤–Ω—ñ—à–Ω—å–æ—ó —Ç–æ—á–∫–∏
    echo "üîç –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ –∑–æ–≤–Ω—ñ—à–Ω—å–æ—ó —Ç–æ—á–∫–∏..."
    if timeout 5 bash -c "</dev/tcp/$PUBLIC_IP/3000" 2>/dev/null; then
        echo "‚úÖ –ü–æ—Ä—Ç 3000 –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∑–æ–≤–Ω—ñ"
    else
        echo "‚ùå –ü–æ—Ä—Ç 3000 –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∑–æ–≤–Ω—ñ"
        echo "üí° –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:"
        echo "   1. –§–∞–π—Ä–≤–æ–ª –±–ª–æ–∫—É—î –∑'—î–¥–Ω–∞–Ω–Ω—è"
        echo "   2. –†–æ—É—Ç–µ—Ä –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –¥–ª—è –ø—Ä–æ–±—Ä–æ—Å—É –ø–æ—Ä—Ç—É"
        echo "   3. –ü—Ä–æ–≤–∞–π–¥–µ—Ä –±–ª–æ–∫—É—î –≤—Ö—ñ–¥–Ω—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è"
    fi
else
    echo "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—É–±–ª—ñ—á–Ω—É IP"
fi

echo ""
echo "üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:"
echo "   1. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è —â–æ –ø–æ—Ä—Ç 3000 –≤—ñ–¥–∫—Ä–∏—Ç–∏–π —É —Ñ–∞–π—Ä–≤–æ–ª—ñ"
echo "   2. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç—É 3000 –Ω–∞ —Ä–æ—É—Ç–µ—Ä—ñ"
echo "   3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"
echo "   4. –î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ: telnet $PUBLIC_IP 3000"
