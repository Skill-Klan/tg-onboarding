#!/bin/bash

# üöÄ –°–∫—Ä–∏–ø—Ç –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –∑–∞–ø—É—Å–∫—É FAQ Web App –ø—Ä–æ–µ–∫—Ç—É
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø—É—Å–∫–∞—î —Å–µ—Ä–≤–µ—Ä —Ç–∞ –±–æ—Ç–∞

echo "üöÄ –ó–∞–ø—É—Å–∫ FAQ Web App –ø—Ä–æ–µ–∫—Ç—É..."
echo "=================================="

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∑–Ω–∞—Ö–æ–¥–∏–º–æ—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π –ø–∞–ø—Ü—ñ
if [ ! -f "package.json" ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: package.json –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!"
    echo "üí° –ü–µ—Ä–µ–π–¥—ñ—Ç—å –≤ –ø–∞–ø–∫—É tg_bot —Ç–∞ –∑–∞–ø—É—Å—Ç—ñ—Ç—å —Å–∫—Ä–∏–ø—Ç –∑–Ω–æ–≤—É"
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
if [ ! -d "node_modules" ]; then
    echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
    npm install
fi

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
echo "üîß –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó..."
if npm run validate > /dev/null 2>&1; then
    echo "‚úÖ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –≤–∞–ª—ñ–¥–Ω–∞"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó!"
    echo "üí° –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ .env —Ñ–∞–π–ª"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–µ—Ä–≤–µ—Ä —É —Ñ–æ–Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ
echo "üåê –ó–∞–ø—É—Å–∫ FAQ —Å–µ—Ä–≤–µ—Ä–∞..."
npm run server &
SERVER_PID=$!

# –ß–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞..."
sleep 3

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π
if curl -s http://localhost:3000/ > /dev/null; then
    echo "‚úÖ FAQ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π –Ω–∞ http://localhost:3000"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞!"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –±–æ—Ç–∞
echo "ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞..."
npm run dev &
BOT_PID=$!

# –ß–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞..."
sleep 5

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω–∏–π
if ps -p $BOT_PID > /dev/null; then
    echo "‚úÖ Telegram –±–æ—Ç –∑–∞–ø—É—â–µ–Ω–∏–π"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞!"
    exit 1
fi

echo ""
echo "üéâ –ü—Ä–æ–µ–∫—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!"
echo "=================================="
echo "üåê FAQ —Å–µ—Ä–≤–µ—Ä: http://localhost:3000"
echo "üì± FAQ —Å—Ç–æ—Ä—ñ–Ω–∫–∞: http://localhost:3000/faq.html"
echo "ü§ñ –ë–æ—Ç: –ø—Ä–∞—Ü—é—î –≤ —Ä–µ–∂–∏–º—ñ —Ä–æ–∑—Ä–æ–±–∫–∏"
echo ""
echo "üí° –î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è:"
echo "   1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ http://localhost:3000/faq.html —É –±—Ä–∞—É–∑–µ—Ä—ñ"
echo "   2. –í—ñ–¥–ø—Ä–∞–≤—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É /start"
echo "   3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å 'üìö FAQ' –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è Web App"
echo ""
echo "üõë –î–ª—è –∑—É–ø–∏–Ω–∫–∏: –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å Ctrl+C"

# –§—É–Ω–∫—Ü—ñ—è –æ—á–∏—â–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ
cleanup() {
    echo ""
    echo "üõë –ó—É–ø–∏–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç—É..."
    kill $SERVER_PID 2>/dev/null
    kill $BOT_PID 2>/dev/null
    echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –∑—É–ø–∏–Ω–µ–Ω–æ"
    exit 0
}

# –û–±—Ä–æ–±–∫–∞ —Å–∏–≥–Ω–∞–ª—É –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
trap cleanup SIGINT SIGTERM

# –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
wait
