#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ Telegram Bot –∑ –ø—É–±–ª—ñ—á–Ω–æ—é IP..."

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ
cleanup() {
    echo -e "\nüõë –ó—É–ø–∏–Ω–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
    if [ ! -z "$SERVER_PID" ]; then
        kill $SERVER_PID 2>/dev/null
        echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑—É–ø–∏–Ω–µ–Ω–æ"
    fi
    exit 0
}

# –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ —Å–∏–≥–Ω–∞–ª—ñ–≤
trap cleanup SIGINT SIGTERM

# –û—Ç—Ä–∏–º—É—î–º–æ –ø—É–±–ª—ñ—á–Ω—É IP
echo "üåê –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—É–±–ª—ñ—á–Ω–æ—ó IP..."
PUBLIC_IP=$(curl -s --max-time 5 ifconfig.me 2>/dev/null)

if [ -z "$PUBLIC_IP" ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—É–±–ª—ñ—á–Ω—É IP"
    exit 1
fi

echo "‚úÖ –ü—É–±–ª—ñ—á–Ω–∞ IP: $PUBLIC_IP"

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
export PUBLIC_URL="http://$PUBLIC_IP:3000"
export FAQ_WEBAPP_URL="http://$PUBLIC_IP:3000/faq.html"

echo "üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞:"
echo "   PUBLIC_URL: $PUBLIC_URL"
echo "   FAQ_WEBAPP_URL: $FAQ_WEBAPP_URL"

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–Ω–∏–π
echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ –ø–æ—Ä—Ç—É 3000..."
if netstat -tuln 2>/dev/null | grep -q ":3000 "; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ü–æ—Ä—Ç 3000 –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π"
    echo "üí° –ó—É–ø–∏–Ω—ñ—Ç—å —ñ–Ω—à—ñ —Å–µ—Ä–≤—ñ—Å–∏ –∞–±–æ –∑–º—ñ–Ω—ñ—Ç—å –ø–æ—Ä—Ç"
    exit 1
fi

echo "‚úÖ –ü–æ—Ä—Ç 3000 –≤—ñ–ª—å–Ω–∏–π"

# –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–µ—Ä–≤–µ—Ä
echo "üì° –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
npm start &
SERVER_PID=$!

# –ß–µ–∫–∞—î–º–æ –ø–æ–∫–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞..."
sleep 5

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π
if ! curl -s http://localhost:3000 > /dev/null; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è"
    cleanup
fi

echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É 3000"
echo "üåê –õ–æ–∫–∞–ª—å–Ω–∏–π –¥–æ—Å—Ç—É–ø: http://localhost:3000"
echo "üåç –ü—É–±–ª—ñ—á–Ω–∏–π –¥–æ—Å—Ç—É–ø: $PUBLIC_URL"
echo "üì± Web App URL: $FAQ_WEBAPP_URL"
echo ""
echo "‚ö†Ô∏è  –í–∞–∂–ª–∏–≤–æ:"
echo "   1. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è —â–æ –ø–æ—Ä—Ç 3000 –≤—ñ–¥–∫—Ä–∏—Ç–∏–π —É —Ñ–∞–π—Ä–≤–æ–ª—ñ"
echo "   2. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç—É –Ω–∞ —Ä–æ—É—Ç–µ—Ä—ñ"
echo "   3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–æ—Ç–∞ –≤ @BotFather"
echo ""
echo "üí° –î–ª—è –∑—É–ø–∏–Ω–∫–∏ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å Ctrl+C"
echo ""

# –û—á—ñ–∫—É—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
wait
