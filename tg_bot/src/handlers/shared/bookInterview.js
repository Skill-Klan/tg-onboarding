import askName from './askName.js';
import askPhone from './askPhone.js';
import { AWAITING_STATES } from '../../utils/constants.js';

/**
 * Handler –¥–ª—è –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è —ñ–Ω—Ç–µ—Ä–≤'—é (Backend –Ω–∞–ø—Ä—è–º)
 */
export default async function bookInterview(ctx) {
  try {
    // –í–∞–ª—ñ–¥–∞—Ü—ñ—è: –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∏—Ö –¥–∞–Ω–∏—Ö
    if (!ctx.session.name) {
      // –ü–æ—á–∏–Ω–∞—î–º–æ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–π –∑–±—ñ—Ä –¥–∞–Ω–∏—Ö - —Å–ø–æ—á–∞—Ç–∫—É —ñ–º'—è
      ctx.session.awaiting = AWAITING_STATES.NAME;
      ctx.session.pendingAction = 'book_interview'; // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏ –ø—ñ—Å–ª—è –∑–±–æ—Ä—É –¥–∞–Ω–∏—Ö
      await ctx.reply('üìù –î–ª—è –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è —ñ–Ω—Ç–µ—Ä–≤\'—é –ø–æ—Ç—Ä—ñ–±–Ω—ñ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ.\n\n–î–∞–≤–∞–π—Ç–µ –∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—è!', { parse_mode: 'HTML' });
      await ctx.answerCbQuery('üìù –ü–æ—Ç—Ä—ñ–±–Ω—ñ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ');
      return askName(ctx);
    }

    if (!ctx.session.phone) {
      // –Ø–∫—â–æ —ñ–º'—è —î, –∞–ª–µ –Ω–µ–º–∞—î —Ç–µ–ª–µ—Ñ–æ–Ω—É
      ctx.session.awaiting = AWAITING_STATES.PHONE;
      ctx.session.pendingAction = 'book_interview';
      await ctx.reply('üì± –¢–µ–ø–µ—Ä –ø–æ—Ç—Ä—ñ–±–µ–Ω –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –∑–≤\'—è–∑–∫—É.', { parse_mode: 'HTML' });
      await ctx.answerCbQuery('üì± –ü–æ—Ç—Ä—ñ–±–µ–Ω –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É');
      return askPhone(ctx);
    }

    // –Ø–∫—â–æ –≤—Å—ñ –¥–∞–Ω—ñ —î - –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—à–Ω–µ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è
    await ctx.reply(
      `üìÖ <b>–ó–∞—è–≤–∫–∞ –Ω–∞ —ñ–Ω—Ç–µ—Ä–≤'—é –ø—Ä–∏–π–Ω—è—Ç–∞!</b>

–í–∞—à—ñ –¥–∞–Ω—ñ:
üë§ –Ü–º'—è: ${ctx.session.name}
üì± –¢–µ–ª–µ—Ñ–æ–Ω: ${ctx.session.phone}
üíª –ù–∞–ø—Ä—è–º: Backend

–ù–∞—à—ñ –º–µ–Ω–µ–¥–∂–µ—Ä–∏ –∑–≤'—è–∂—É—Ç—å—Å—è –∑ –≤–∞–º–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º –¥–ª—è —É–∑–≥–æ–¥–∂–µ–Ω–Ω—è –∑—Ä—É—á–Ω–æ–≥–æ —á–∞—Å—É —ñ–Ω—Ç–µ—Ä–≤'—é.

–î—è–∫—É—î–º–æ –∑–∞ –≤–∞—à —ñ–Ω—Ç–µ—Ä–µ—Å –¥–æ SkillKlan! üöÄ`,
      { parse_mode: 'HTML' }
    );

    await ctx.answerCbQuery('‚úÖ –ó–∞—è–≤–∫—É –ø–æ–¥–∞–Ω–æ!');
    
    // –û—á–∏—â–∞—î–º–æ pending action
    delete ctx.session.pendingAction;
    
    // TODO: –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–∏—Ö –≤ CRM –∞–±–æ –±–∞–∑—É –¥–∞–Ω–∏—Ö
    
  } catch (error) {
    console.error('–ü–æ–º–∏–ª–∫–∞ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è —ñ–Ω—Ç–µ—Ä–≤\'—é:', error);
    await ctx.answerCbQuery('‚ùå –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
  }
}
