import commonTexts from '../../texts/common.js';
import { AWAITING_STATES, CALLBACK_DATA } from '../../utils/constants.js';
import { getMainKeyboard } from '../../utils/keyboard.js';
import fs from 'fs';
import path from 'path';

export default async function sendPDF(ctx, track) {
  try {
    console.log(`üöÄ –ü–æ—á–∞—Ç–æ–∫ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è PDF –¥–ª—è –Ω–∞–ø—Ä—è–º–∫—É: ${track}`);
    
    // 1. –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Ç–µ—Å—Ç—É
    console.log('üìù –ù–∞–¥—Å–∏–ª–∞—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Ç–µ—Å—Ç—É...');
    await ctx.reply(commonTexts.sendingTest, {
      parse_mode: 'HTML'
    });
    console.log('‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Ç–µ—Å—Ç—É –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ');

    // 2. –Ü–º—ñ—Ç–∞—Ü—ñ—è –¥—ñ—ó
    console.log('‚è≥ –Ü–º—ñ—Ç—É—é –¥—ñ—é –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...');
    await ctx.telegram.sendChatAction(ctx.chat.id, 'upload_document');
    await new Promise(resolve => setTimeout(resolve, 2000));
    console.log('‚úÖ –î—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');

    // 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è PDF —Ñ–∞–π–ª—É
    const pdfPath = path.join(process.cwd(), 'pdf', `${track}.pdf`);
    console.log(`üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—é —à–ª—è—Ö –¥–æ PDF: ${pdfPath}`);
    
    if (!fs.existsSync(pdfPath)) {
      console.error(`‚ùå PDF —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: ${pdfPath}`);
      await ctx.reply(
        '‚ö†Ô∏è –í–∏–±–∞—á—Ç–µ, —Ç–µ—Å—Ç–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∏–º—á–∞—Å–æ–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏.',
        { parse_mode: 'HTML' }
      );
      return;
    }
    console.log('‚úÖ PDF —Ñ–∞–π–ª –∑–Ω–∞–π–¥–µ–Ω–æ');

    // 4. –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è PDF
    console.log('üìÑ –ù–∞–¥—Å–∏–ª–∞—é PDF –¥–æ–∫—É–º–µ–Ω—Ç...');
    await ctx.replyWithDocument({ source: pdfPath });
    console.log('‚úÖ PDF –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ');

    // 5. –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
    console.log('üîÑ –°–∫–∏–¥–∞—é —Å—Ç–∞–Ω –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è...');
    ctx.session.awaiting = null;
    console.log('‚úÖ –°—Ç–∞–Ω –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è —Å–∫–∏–Ω—É—Ç–æ');

    // 6. –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –Ω–∞—Ç–∏–≤–Ω–∏–º –º–µ–Ω—é –≤–Ω–∏–∑—É
    console.log('‚å®Ô∏è –ü–æ–∫–∞–∑—É—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –Ω–∞—Ç–∏–≤–Ω–∏–º –º–µ–Ω—é...');
    await ctx.reply(
      'üìö –û—Å—å —Ç–µ—Å—Ç–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è, –º–æ–∂–µ—à —Å–º—ñ–ª–∏–≤–æ –æ–∑–Ω–∞–π–æ–º–ª—é–≤–∞—Ç–∏—Å—è!',
      {
        ...getMainKeyboard(),
        parse_mode: 'HTML'
      }
    );
    console.log('‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –Ω–∞—Ç–∏–≤–Ω–∏–º –º–µ–Ω—é –ø–æ–∫–∞–∑–∞–Ω–æ');

    console.log(`üéâ PDF —É—Å–ø—ñ—à–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –¥–ª—è –Ω–∞–ø—Ä—è–º–∫—É: ${track}`);
    
  } catch (error) {
    console.error(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—ñ PDF –¥–ª—è –Ω–∞–ø—Ä—è–º–∫—É ${track}:`, error);
    console.error('üìç Stack trace:', error.stack);
    
    // –ù–µ –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É, —è–∫—â–æ PDF –≤–∂–µ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ
    if (ctx.session.awaiting === null) {
      console.log('‚úÖ PDF –≤–∂–µ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ, –ø–æ–º–∏–ª–∫–∞ –≤ –ø–æ–∫–∞–∑—ñ –º–µ–Ω—é - —ñ–≥–Ω–æ—Ä—É—î–º–æ');
      return;
    }
    
    await ctx.reply(
      '‚ö†Ô∏è –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—ñ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏.',
      { parse_mode: 'HTML' }
    );
  }
}