#!/bin/bash

# üöÄ –®–≤–∏–¥–∫–∏–π —Å–∫—Ä–∏–ø—Ç –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –∑–∞–ø—É—Å–∫—É Telegram –±–æ—Ç–∞
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ü–µ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Å—Ç–∞—Ä—Ç—É

set -e

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

log_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

echo "üöÄ –®–≤–∏–¥–∫–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Telegram –±–æ—Ç–∞"
echo "======================================"

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Ç–æ–∫–µ–Ω–∞
if [ -z "$BOT_TOKEN" ]; then
    log_warning "BOT_TOKEN –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π"
    echo ""
    echo "–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –æ–¥–Ω–∏–º –∑ —Å–ø–æ—Å–æ–±—ñ–≤:"
    echo ""
    echo "1. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–º—ñ–Ω–Ω—É —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞:"
    echo "   export BOT_TOKEN='–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞'"
    echo ""
    echo "2. –ê–±–æ –∑–∞–ø—É—Å—Ç—ñ—Ç—å —Å–∫—Ä–∏–ø—Ç –∑ —Ç–æ–∫–µ–Ω–æ–º:"
    echo "   BOT_TOKEN='–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞' ./quick-setup.sh"
    echo ""
    echo "3. –ê–±–æ –≤–≤–µ–¥—ñ—Ç—å —Ç–æ–∫–µ–Ω –∑–∞—Ä–∞–∑:"
    read -p "–í–≤–µ–¥—ñ—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞: " BOT_TOKEN
    
    if [ -z "$BOT_TOKEN" ]; then
        log_error "–¢–æ–∫–µ–Ω –Ω–µ –≤–≤–µ–¥–µ–Ω–æ. –í–∏—Ö—ñ–¥."
        exit 1
    fi
fi

log_success "–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

# –ü–µ—Ä–µ—Ö—ñ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –±–æ—Ç–∞
cd tg_bot

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ node_modules
if [ ! -d "node_modules" ]; then
    log_info "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
    npm ci --only=production
    log_success "–ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
else
    log_info "–ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ"
fi

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è .env —Ñ–∞–π–ª—É
log_info "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è .env —Ñ–∞–π–ª—É..."
cat > .env << EOF
BOT_TOKEN=$BOT_TOKEN
NODE_ENV=production
LOG_LEVEL=info
PORT=3000
EOF
log_success ".env —Ñ–∞–π–ª —Å—Ç–≤–æ—Ä–µ–Ω–æ"

# –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
log_info "–í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó..."
if npm run validate; then
    log_success "–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –≤–∞–ª—ñ–¥–Ω–∞"
else
    log_warning "–ü–æ–º–∏–ª–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó, –∞–ª–µ –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ..."
fi

# –ó—É–ø–∏–Ω–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É
log_info "–ó—É–ø–∏–Ω–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É..."
pkill -f "node.*index.mjs" || log_warning "–°—Ç–∞—Ä–∏–π –ø—Ä–æ—Ü–µ—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π"

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
log_info "–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
nohup npm start > ../bot.log 2>&1 &
BOT_PID=$!

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ø—É—Å–∫—É
sleep 3
if ps -p $BOT_PID > /dev/null; then
    log_success "–ë–æ—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∏–π (PID: $BOT_PID)"
    echo ""
    echo "üìã –ö–æ—Ä–∏—Å–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:"
    echo "  ./deploy.sh status  - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞"
    echo "  ./deploy.sh logs    - –ü–æ–¥–∏–≤–∏—Ç–∏—Å—è –ª–æ–≥–∏"
    echo "  ./deploy.sh         - –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–æ–≤–Ω–∏–π –¥–µ–ø–ª–æ–π"
    echo ""
    echo "üìÅ –§–∞–π–ª–∏:"
    echo "  –õ–æ–≥–∏: ../bot.log"
    echo "  –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è: .env"
    echo "  PID: $BOT_PID"
else
    log_error "–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞"
    echo ""
    echo "–û—Å—Ç–∞–Ω–Ω—ñ –ª–æ–≥–∏:"
    tail -10 ../bot.log
    echo ""
    echo "–°–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Ä—É—á–Ω—É:"
    echo "  cd tg_bot && npm start"
    exit 1
fi
